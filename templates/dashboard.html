<!DOCTYPE html>
<html>
<head>
    <title>ISS Live Tracker - TFB2093 IoT Project</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; }
        #map { height: 500px; width: 100%; }
        .dashboard { display: flex; flex-wrap: wrap; padding: 15px; gap: 15px; }
        .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex: 1 1 200px; }
        .card h3 { margin-top: 0; color: #007bff; }
        .live-data { font-size: 1.2em; font-weight: bold; }
        #altitudeChartContainer { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

    <h1 style="text-align: center; padding: 10px; background-color: #333; color: white; margin-bottom: 0;">üõ∞Ô∏è ISS Live Telemetry Dashboard</h1>
    
    <div id="map"></div>

    <div class="dashboard">
        <div class="card">
            <h3>Current Location</h3>
            <p>Latitude: <span id="current-lat" class="live-data">--</span></p>
            <p>Longitude: <span id="current-lon" class="live-data">--</span></p>
            <p>Altitude: <span id="current-alt" class="live-data">--</span> km</p>
        </div>
        <div class="card">
            <h3>Real-Time Data & Analytics</h3>
            <p>Velocity: <span id="current-vel" class="live-data">--</span> km/h</p>
            <p>Time (UTC): <span id="current-time" class="live-data">--</span></p>
            <p>Alt Change (Last 1hr): <span id="alt-change" class="live-data">--</span> km</p>
        </div>
        <div class="card">
            <h3>3-Day Extremes</h3>
            <p>Max Longitude: <span id="max-lon" class="live-data">--</span></p>
            <p>Min Longitude: <span id="min-lon" class="live-data">--</span></p>
            <p>Max Altitude: <span id="max-alt" class="live-data">--</span> km</p>
            <p>Min Altitude: <span id="min-alt" class="live-data">--</span> km</p>
        </div>
    </div>
    
    <div style="padding: 15px;">
        <h2>Altitude History (Last 12 Hours)</h2>
        <div id="altitudeChartContainer">
            <canvas id="altitudeChart"></canvas>
        </div>
    </div>

    <script>
        // --- 1. Map and Chart Initialization ---
        
        // Leaflet Map Setup
        const map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        const issIcon = L.icon({
            iconUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/d/d0/International_Space_Station_%28ISS%29.svg/100px-International_Space-Station_%28ISS%29.svg.png',
            iconSize: [50, 32], 
            iconAnchor: [25, 16], 
        });

        let issMarker = L.marker([0, 0], {icon: issIcon}).addTo(map);
        let pathLine = L.polyline([], {color: 'red', weight: 2}).addTo(map);

        // Chart.js Setup
        const ctx = document.getElementById('altitudeChart').getContext('2d');
        let altitudeChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Altitude (km)',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1,
                    fill: false
                }]
            },
            options: {
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'hour'
                        },
                        title: {
                            display: true,
                            text: 'Time (UTC)'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Altitude (km)'
                        }
                    }
                }
            }
        });


        // --- 2. Data Fetching and Updating Functions ---
        
        async function updatePathAndChart() {
            const response = await fetch('/api/path_history');
            const data = await response.json();
            
            // Update Map Path
            pathLine.setLatLngs(data.path);
            
            // Update Chart Data
            altitudeChart.data.labels = data.chart.timestamps.map(ts => new Date(ts));
            altitudeChart.data.datasets[0].data = data.chart.altitudes;
            altitudeChart.update();
        }

        async function updateDashboard() {
            const response = await fetch('/api/realtime_data');
            const data = await response.json();
            
            const iss = data.iss;
            const analytics = data.analytics;

            if (iss.latitude && iss.longitude) {
                const lat = iss.latitude;
                const lon = iss.longitude;
                
                // Update Marker Position and Map View
                const newLatLng = new L.LatLng(lat, lon);
                issMarker.setLatLng(newLatLng).bindPopup(`<b>ISS Current Position</b><br>Altitude: ${iss.altitude.toFixed(2)} km`).openPopup(); 

                // Update Real-time Metrics
                document.getElementById('current-lat').textContent = lat.toFixed(4);
                document.getElementById('current-lon').textContent = lon.toFixed(4);
                document.getElementById('current-alt').textContent = iss.altitude ? iss.altitude.toFixed(2) : '--';
                document.getElementById('current-vel').textContent = iss.velocity ? iss.velocity.toFixed(2) : '--';
                
                const date = new Date(iss.timestamp_utc * 1000);
                document.getElementById('current-time').textContent = date.toLocaleTimeString('en-US', { hour12: false, timeZone: 'UTC' }) + ' UTC';
            }
            
            // Update Analytics Metrics
            document.getElementById('max-lon').textContent = analytics.max_lon ? analytics.max_lon.toFixed(4) : '--';
            document.getElementById('min-lon').textContent = analytics.min_lon ? analytics.min_lon.toFixed(4) : '--';
            document.getElementById('max-alt').textContent = analytics.max_alt ? analytics.max_alt.toFixed(2) : '--';
            document.getElementById('min-alt').textContent = analytics.min_alt ? analytics.min_alt.toFixed(2) : '--';
            document.getElementById('alt-change').textContent = analytics.altitude_change_km || '--';
        }

        // --- 3. Run Logic ---
        updatePathAndChart(); // Initial load for map path and chart data
        updateDashboard();    // Initial data load for metrics

        // Set intervals for updates
        setInterval(updateDashboard, 5000); // Update position and metrics every 5 seconds
        setInterval(updatePathAndChart, 300000); // Update path and chart data every 5 minutes (less frequent)

    </script>
    
</body>
</html>
